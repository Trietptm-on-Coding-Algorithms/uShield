/*

************************************
* Extended Exploitation Test (EET) *
************************************
(c) Jos Wetzels, Wouter Bokslag

Format String Vulnerability
Minimal format string vulnerability where the target is to overwrite the function return address on the stack.

Protections:
	XN
	Stack Cookies
	Full RELRO
	ASLR (host-enabled)

$ gcc -Bdynamic -lc -ldl -lrt -lm -lpthread -lgcc_s -fstack-protector-all -Wformat -Wformat-security -Wconversion -Wsign-conversion -Wl,-z,relro,-z,now -o format_string_vuln format_string_vuln.c

*/
#define _GNU_SOURCE

#define BUFFER_SIZE 4588
#define READ_SIZE BUFFER_SIZE

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <link.h>

extern uint32_t __stack_chk_guard;

int infoleak_callback(struct dl_phdr_info *info, size_t size, void *data)
{
	fprintf(stdout, "[%s]@[%p]\n", info->dlpi_name, (void*)info->dlpi_addr);
	return 0;
}

__attribute__ ((naked)) void pivot_gadget()
{
	asm volatile("sub sp, sp, #4544\n\t"
				 "add sp, sp, #10\n\t"
				 "pop {pc}"
				);
}

__attribute__ ((naked)) void arg_gadget()
{
  asm volatile("pop {r0, r1, r2, r3, lr}\n\t"
               "bx r3");
  return;
}

void info_leak()
{
	uint32_t sp;

	asm volatile("mov %0, sp"
				 : "=r" (sp)
				);

	/* disclose stack pointer and stack cookie */
	fprintf(stdout, "[%04x.%04x]\n", sp, __stack_chk_guard);

	/* disclose loaded object base addresses */
	dl_iterate_phdr(infoleak_callback, NULL);

	fprintf(stdout, "> ");
	fflush(stdout);

	return;
}

void vuln_func()
{	
	unsigned char buffer[BUFFER_SIZE] = {0};
	
	info_leak();

	fgets(buffer, (READ_SIZE - 1), stdin);

	/* format string vulnerability */
	fprintf(stdout, buffer);
	fflush(stdout);

	return;
}

int main(int argc, char* argv[])
{
	vuln_func();
}